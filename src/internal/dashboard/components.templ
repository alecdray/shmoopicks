package dashboard

import (
	"fmt"
	"shmoopicks/src/internal/core/db/models"
	"shmoopicks/src/internal/core/templates"
	"shmoopicks/src/internal/feed"
	"shmoopicks/src/internal/library"
)

type DashboardPageProps struct {
	Feeds   []feed.FeedDTO
	Library *library.Library
}

func getFeedsDropdownButtonIndicatorColor(feeds []feed.FeedDTO) templates.NeonColor {
	color := templates.NeonColorSuccess
	for _, f := range feeds {
		if f.LastSyncStatus.IsSyncFailed() {
			color = templates.NeonColorError
			break
		} else if f.LastSyncStatus.IsUnsyned() || f.IsSyncStale() {
			color = templates.NeonColorWarning
		}
	}
	return color
}

templ feedsDropdownButton(feeds []feed.FeedDTO, oob bool) {
	<div
		id="feeds-dropdown-button"
		tabindex="0"
		role="button"
		class="btn btn-ghost btn-xs gap-1.5"
		if oob {
			hx-swap-oob="true"
		}
	>
		@templates.DatabaseIcon(templates.IconProps{})
		<span class="text-xs">Feeds</span>
		if len(feeds) > 0 {
			@templates.NeonEffect(getFeedsDropdownButtonIndicatorColor(feeds), templates.NeonHoverEffectNone, "rounded-full") {
				<div
					class={ "w-2 h-2 rounded-full", }
				></div>
			}
		}
	</div>
}

templ feedsDropdown(feeds []feed.FeedDTO) {
	<div class="dropdown dropdown-end">
		@feedsDropdownButton(feeds, false)
		<div tabindex="0" class="dropdown-content z-[1] card card-compact bg-base-100 shadow-xl border border-base-300 mt-1">
			@feedsDropdownContent(feeds)
		</div>
	</div>
}

templ feedsDropdownContent(feeds []feed.FeedDTO) {
	<div
		id="feeds-dropdown-content"
		class="menu menu-compact w-56 p-2"
		hx-get="/app/dashboard/feeds-dropdown-content"
		hx-trigger="every 30s"
		hx-swap="outerHTML"
	>
		<div class="menu-title px-2 py-1">
			<span class="text-xs font-semibold opacity-60">Feed Status</span>
		</div>
		if len(feeds) == 0 {
			<div class="px-2 py-3 text-xs opacity-50">No feeds configured</div>
		} else {
			for _, f := range feeds {
				<div class="flex items-center justify-between px-2 py-2 hover:bg-base-200 rounded-lg">
					<div class="flex items-center gap-2">
						if f.LastSyncStatus.IsUnsyned() {
							<div class="text-warning">
								@templates.WarningIcon(templates.IconProps{Style: templates.IconStyleOutline})
							</div>
						} else if f.LastSyncStatus.IsSyncing() {
							<div class="text-info">
								@templates.SpinnerIcon(templates.IconProps{})
							</div>
						} else if f.LastSyncStatus == models.FeedSyncStatusFailure {
							<div class="text-error">
								@templates.XMarkIcon(templates.IconProps{Style: templates.IconStyleOutline})
							</div>
						} else if f.LastSyncStatus.IsSynced() {
							<div class={ templ.KV("text-success", !f.IsSyncStale()), templ.KV("text-warning", f.IsSyncStale()) }>
								@templates.CheckIcon(templates.IconProps{Style: templates.IconStyleOutline})
							</div>
						}
						<span class="text-sm font-medium">{ string(f.Kind) }</span>
					</div>
					<div class="text-xs opacity-60">
						if f.LastSyncStatus.IsUnsyned() {
							Never synced
						} else if f.LastSyncStatus.IsSyncing() {
							Syncing...
						} else if f.LastSyncStatus == models.FeedSyncStatusFailure {
							Failed
						} else if f.IsSyncStale() {
							Stale
						} else {
							Synced
						}
					</div>
				</div>
			}
		}
	</div>
}

templ releaseFormatIcon(format models.ReleaseFormat) {
	switch format {
		case models.ReleaseFormatVinyl:
			@templates.VinylIcon(templates.IconProps{})
		case models.ReleaseFormatCD:
			@templates.CDIcon(templates.IconProps{})
		case models.ReleaseFormatCassette:
			@templates.CassetteIcon(templates.IconProps{})
		case models.ReleaseFormatDigital:
			@templates.DigitalIcon(templates.IconProps{})
	}
}

templ releaseFormatBadge(release library.ReleaseDTO) {
	<div class="tooltip" data-tip={ "Added: " + release.AddedAt.Format("Jan 2, 2006") }>
		<div class="badge badge-sm gap-1.5">
			@releaseFormatIcon(release.Format)
			<span class="text-xs capitalize">{ string(release.Format) }</span>
		</div>
	</div>
}

templ formatIcon(releases library.ReleaseDTOs, format models.ReleaseFormat) {
	if release := releases.FindFormat(format); release != nil && release.AddedAt != nil {
		<div class="tooltip tooltip-top" data-tip={ string(format) + " - " + release.AddedAt.Format("Jan 2, 2006") }>
			<div class="opacity-100">
				@releaseFormatIcon(format)
			</div>
		</div>
	} else {
		<div class="tooltip tooltip-top" data-tip={ string(format) + " - Not in library" }>
			<div class="opacity-20">
				@releaseFormatIcon(format)
			</div>
		</div>
	}
}

templ albumRow(album library.AlbumDTO) {
	<tr class="hover:bg-base-300 transition-colors duration-150">
		<td class="font-medium">{ album.Title }</td>
		<td>
			if len(album.Artists) > 0 {
				for i, artist := range album.Artists {
					if i > 0 {
						<span>, </span>
					}
					<span>{ artist.Name }</span>
				}
			}
		</td>
		<td>
			<div class="flex gap-3 items-center">
				@formatIcon(album.Releases, models.ReleaseFormatDigital)
				@formatIcon(album.Releases, models.ReleaseFormatVinyl)
				@formatIcon(album.Releases, models.ReleaseFormatCD)
				@formatIcon(album.Releases, models.ReleaseFormatCassette)
			</div>
		</td>
		<td>
			if oldest := album.Releases.OldestAddedAtDate(); oldest != nil {
				<span class="text-sm">{ oldest.Format("Jan 2, 2006") }</span>
			}
		</td>
	</tr>
}

templ albumsTableBody(albums []library.AlbumDTO) {
	if len(albums) == 0 {
		<tr>
			<td colspan="4" class="text-center opacity-50">No albums in your library</td>
		</tr>
	} else {
		for _, album := range albums {
			@albumRow(album)
		}
	}
}

templ albumsTableSortableHeader(colName, sortedBy, sortedDir string) {
	<th
		class="cursor-pointer hover:bg-base-200"
		hx-target="#album-table"
		hx-swap="outerHTML"
		class="inline-block mr-1"
		if sortedBy == colName && sortedDir == "desc" {
			hx-get={ fmt.Sprintf("/app/dashboard/albums-table?sortBy=%s&dir=asc", colName) }
		} else {
			hx-get={ fmt.Sprintf("/app/dashboard/albums-table?sortBy=%s&dir=desc", colName) }
		}
	>
		{ children... }
		<span>
			if sortedBy == colName && sortedDir == "desc" {
				↑
			} else {
				↓
			}
		</span>
	</th>
}

templ AlbumsTable(albums []library.AlbumDTO, sortedBy string, sortedDir string) {
	<div id="album-table" class="w-full px-6 py-6">
		<div class="w-full">
			<table class="table table-zebra w-full table-fixed">
				<colgroup>
					<col style="width: 35%"/>
					<col style="width: 35%"/>
					<col style="width: 18%"/>
					<col style="width: 12%"/>
				</colgroup>
				<thead>
					<tr>
						@albumsTableSortableHeader("album", sortedBy, sortedDir) {
							<span>Album</span>
						}
						@albumsTableSortableHeader("artist", sortedBy, sortedDir) {
							<span>Artists</span>
						}
						<th>Formats</th>
						@albumsTableSortableHeader("date", sortedBy, sortedDir) {
							<span>Date Added</span>
						}
					</tr>
				</thead>
				<tbody id="albums-tbody">
					@albumsTableBody(albums)
				</tbody>
			</table>
		</div>
	</div>
}

templ LibraryStats(lib *library.Library) {
	if lib != nil {
		<div class="w-full bg-base-200 border-b border-base-300 flex-shrink-0">
			<div class="px-6">
				<div class="stats stats-horizontal shadow-sm w-full">
					<div class="stat py-2">
						<div class="stat-title text-xs">Artists</div>
						<div class="stat-value text-2xl">{ fmt.Sprintf("%d", len(lib.Artists)) }</div>
					</div>
					<div class="stat py-2">
						<div class="stat-title text-xs">Albums</div>
						<div class="stat-value text-2xl">{ fmt.Sprintf("%d", len(lib.Albums)) }</div>
					</div>
					<div class="stat py-2">
						<div class="stat-title text-xs">Tracks</div>
						<div class="stat-value text-2xl">{ fmt.Sprintf("%d", len(lib.Tracks)) }</div>
					</div>
				</div>
			</div>
		</div>
	}
}

templ DashboardHeaderBar(feeds []feed.FeedDTO) {
	<div class="bg-base-100 border-b border-base-300 h-11 w-full flex-shrink-0" hx-boost="true">
		<div class="h-full flex items-center justify-between px-6">
			<div class="flex items-center gap-4">
				@templates.NeonTextEffect(templates.NeonColorPrimary, templates.NeonHoverEffectDim) {
					<a href="/home" class="text-lg font-brand">wax</a>
				}
				<div class="h-4 w-px bg-base-300"></div>
				<div class="flex items-center gap-1">
					<div class="tooltip tooltip-bottom" data-tip="Home">
						<a href="/home" class="btn btn-ghost btn-xs btn-square">
							@templates.HomeIcon(templates.IconProps{Style: templates.IconStyleOutline})
						</a>
					</div>
				</div>
			</div>
			<div class="flex items-center gap-2">
				@feedsDropdown(feeds)
				<div class="h-4 w-px bg-base-300"></div>
				<div class="dropdown dropdown-end">
					<div tabindex="0" role="button" class="btn btn-ghost btn-xs btn-circle">
						@templates.UserIcon(templates.IconProps{Style: templates.IconStyleOutline})
					</div>
					<ul tabindex="0" class="dropdown-content z-[1] menu menu-compact bg-base-100 rounded-box w-32 shadow-xl border border-base-300 mt-1">
						<li><a href="/logout" class="text-xs">Logout</a></li>
					</ul>
				</div>
			</div>
		</div>
	</div>
}

templ DashboardPage(props DashboardPageProps) {
	@templates.RootComponent(templates.RootProps{
		Title: templates.CreatePageTitle("Dashboard"),
	}) {
		<div class="h-screen w-full flex flex-col overflow-hidden">
			@DashboardHeaderBar(props.Feeds)
			@LibraryStats(props.Library)
			<div class="flex-1 overflow-y-auto">
				if props.Library != nil {
					@AlbumsTable(props.Library.Albums, "date", "desc")
				}
			</div>
		</div>
	}
}
